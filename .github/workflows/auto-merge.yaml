name: Auto-Merge
on:
  pull_request_target:
  # pull_request:

env:
  TZ: Asia/Shanghai
  PKG_NAME: React-Admin
  APP_NAME: auto-merge
  BARK_SOUND: shake
  BARK_LEVEL: active
  BARK_GROUP: GitHub Action
  BARK_ICON: https://static.icloudnote.cn/logo/github.png

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: |
      (github.actor == 'dependabot[bot]' || github.actor == 'icloudnote') &&
      github.event.pull_request.base.ref == 'master'
    steps:
      # è·å– dependabot å…ƒä¿¡æ¯
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Prepare Metadata
        id: vars
        run: |
          echo "DETAIL_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          # è·å– PR çš„æœ€æ–°æäº¤ä¿¡æ¯ï¼ˆä» GitHub äº‹ä»¶ä¸Šä¸‹æ–‡ä¸­ç›´æ¥è·å–æ›´å¯é ï¼‰
          echo "APP_COMMIT=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
      # è·å– dependabot è¯¦ç»†ä¿¡æ¯
      - name: Dependabot metadata
        id: metadata
        if: github.actor == 'dependabot[bot]'
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      # æ£€æŸ¥æ˜¯å¦ä¸º vscode å¼•æ“æ›´æ–°
      - name: Check if vscode engine update
        id: check_vscode
        run: |
          # æ£€æŸ¥ PR æ ‡é¢˜æˆ–æ–‡ä»¶å˜æ›´æ˜¯å¦æ¶‰åŠ vscode å¼•æ“
          if echo "${{ github.event.pull_request.title }}" | grep -i "engines.*vscode" || \
             git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- package.json | grep -A2 -B2 '"engines"' | grep -i '"vscode"'; then
            echo "is_vscode_update=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ° vscode å¼•æ“æ›´æ–°ï¼Œè·³è¿‡è‡ªåŠ¨åˆå¹¶"
          else
            echo "is_vscode_update=false" >> $GITHUB_OUTPUT
          fi
      # å¯ç”¨è‡ªåŠ¨åˆå¹¶å¹¶è‡ªåŠ¨åˆ é™¤åˆ†æ”¯
      - name: Enable auto-merge for Dependabot PRs
        if: steps.check_vscode.outputs.is_vscode_update != 'true'
        run: gh pr merge --auto --rebase --delete-branch "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # æ·»åŠ æ ‡ç­¾æç¤ºæ‰‹åŠ¨å®¡æŸ¥
      - name: Label vscode engine updates
        if: steps.check_vscode.outputs.is_vscode_update == 'true'
        run: |
          gh pr edit "$PR_URL" --add-label "needs-manual-review" --add-label "vscode-engine"
          gh pr comment "$PR_URL" --body "âš ï¸ æ­¤ PR æ¶‰åŠ VSCode å¼•æ“ç‰ˆæœ¬æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨å®¡æŸ¥ä»¥ç¡®ä¿å…¼å®¹æ€§ã€‚"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Bark æˆåŠŸé€šçŸ¥
      - name: Notification Success
        uses: harryzcy/action-bark@v2.3.1
        if: success()
        with:
          status: ${{ job.status }}
          title: "ğŸš€ ${{ env.PKG_NAME }} è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
          body: "åº”ç”¨: ${{ env.APP_NAME }}\nå†…å®¹: ${{ env.APP_COMMIT }}\næ—¶é—´: ${{ env.DETAIL_TIME }}"
          level: active
          icon: ${{ env.BARK_ICON }}
          sound: ${{ env.BARK_SOUND }}
          group: ${{ env.BARK_GROUP }}
          device_key: ${{ secrets.BARK_DEVICE_KEY }}
          bark_server_url: ${{ secrets.BARK_SERVER_URL }}
      # Bark å¤±è´¥é€šçŸ¥
      - name: Notification Failure
        uses: harryzcy/action-bark@v2.3.1
        if: failure()
        with:
          status: ${{ job.status }}
          title: "âŒ ${{ env.PKG_NAME }} è‡ªåŠ¨åˆå¹¶å¤±è´¥"
          body: "åº”ç”¨: ${{ env.APP_NAME }}\nå†…å®¹: ${{ env.APP_COMMIT }}\næ—¶é—´: ${{ env.DETAIL_TIME }}"
          level: critical
          icon: ${{ env.BARK_ICON }}
          sound: ${{ env.BARK_SOUND }}
          group: ${{ env.BARK_GROUP }}
          device_key: ${{ secrets.BARK_DEVICE_KEY }}
          bark_server_url: ${{ secrets.BARK_SERVER_URL }}
