name: Tool-Kit

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  TZ: Asia/Shanghai
  PKG_NAME: VSCode-Tool-Kit
  APP_NAME: VSCode-Tool-Kit
  IMAGE_NAME: VSCode-Tool-Kit
  BARK_SOUND: shake
  BARK_LEVEL: active
  BARK_GROUP: GitHub Action
  BARK_ICON: https://static.icloudnote.cn/logo/github.png

jobs:
  buildx:
    runs-on: ubuntu-latest
    steps:
      # è·å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v6
      # æ·»åŠ  ssh ç§é’¥
      - uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      # è®¾ç½® git ä¿¡æ¯
      - name: Set up Git
        run: |
          git config --global url."git@github.com:icloudnote/".insteadOf "https://github.com/icloudnote/"
          git config user.name changjun
          git config user.email changjun.zcj@gmail.com
      # è·å–å½“å‰æ—¶é—´
      - name: Get current date
        id: date
        run: |
          echo "DETAIL_TIME=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "APP_COMMIT=$(git log -1 --no-merges --pretty=%s)" >> $GITHUB_ENV
      # è®¾ç½® PNPM ç‰ˆæœ¬
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      # è®¾ç½® Node ç‰ˆæœ¬
      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
      # è·å–ä¾èµ–
      - name: Get dependencies
        run: pnpm install --frozen-lockfile
      # Linter
      - name: Linter
        run: pnpm run lint
      # ç¼–è¯‘
      - name: Build
        run: pnpm run build
      # æ‰“åŒ…ç¨‹åº
      - name: Package
        run: pnpm run package
      # Bark æˆåŠŸé€šçŸ¥
      - name: Notification Success
        uses: harryzcy/action-bark@v2.3.2
        if: success()
        with:
          status: ${{ job.status }}
          title: "ğŸš€ ${{ env.PKG_NAME }} æ„å»ºæˆåŠŸ"
          body: "åº”ç”¨: ${{ env.APP_NAME }}\nå†…å®¹: ${{ env.APP_COMMIT }}\næ—¶é—´: ${{ env.DETAIL_TIME }}"
          level: active
          icon: ${{ env.BARK_ICON }}
          sound: ${{ env.BARK_SOUND }}
          group: ${{ env.BARK_GROUP }}
          device_key: ${{ secrets.BARK_DEVICE_KEY }}
          bark_server_url: ${{ secrets.BARK_SERVER_URL }}
      # Bark å¤±è´¥é€šçŸ¥
      - name: Notification Failure
        uses: harryzcy/action-bark@v2.3.2
        if: failure()
        with:
          status: ${{ job.status }}
          title: "âŒ ${{ env.PKG_NAME }} æ„å»ºå¤±è´¥"
          body: "åº”ç”¨: ${{ env.APP_NAME }}\nå†…å®¹: ${{ env.APP_COMMIT }}\næ—¶é—´: ${{ env.DETAIL_TIME }}"
          level: critical
          icon: ${{ env.BARK_ICON }}
          sound: ${{ env.BARK_SOUND }}
          group: ${{ env.BARK_GROUP }}
          device_key: ${{ secrets.BARK_DEVICE_KEY }}
          bark_server_url: ${{ secrets.BARK_SERVER_URL }}
